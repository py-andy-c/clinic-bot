# AI-Native EMR System Proposal & Roadmap

**UUID**: `80056B3A-D137-4550-9146-B4F5183C6ECD`
**Date**: 2026-02-01
**Target Audience**: Clinics in Taiwan

---

## 1. Executive Summary

The goal is to transform the current appointment-focused platform into a comprehensive, AI-native Electronic Medical Record (EMR) system. The core philosophy is to leverage the ubiquity of **LINE** in Taiwan for patient interaction while building a robust, AI-assisted web platform for practitioners.

We will adopt an **evolutionary approach**: starting with solid file management and basic notes, then layering AI capabilities, and finally achieving the "invisible EMR" vision where the system listens and writes notes automatically.

## 2. Market Analysis (Taiwan Context)

### Key Characteristics
1.  **LINE Dominance**: Almost every patient uses LINE. It is the de-facto standard for communication, file transfer, and even payments.
2.  **Clinic Workflow**:
    -   Physical Therapy clinics often involve hands-on treatment where typing is difficult.
    -   Photos/Videos are crucial for tracking progress (range of motion, posture).
    -   Practitioners currently use fragmented tools: LINE for chat, paper/Google Docs for notes, phone gallery for photos.
3.  **Pain Points**:
    -   **Data Silos**: Patient photos are in the doctor's phone; chat history is in LINE; appointment data is in the system.
    -   **Documentation Burden**: Writing notes takes time away from patients.
    -   **Retrieval**: "What did we do last time?" requires digging through chat logs or paper files.

### Opportunity
By centralizing these inputs (LINE files, Appointment Data, Clinical Notes) into one "Patient Timeline," we can provide immense value immediately, even before advanced AI features are fully deployed.

## 3. Technical Feasibility Analysis

### 3.1 LINE Integration (Messaging API)
-   **Current State**: Handles text messages only.
-   **Capabilities**:
    -   **Image/File Messages**: LINE sends message IDs for images/files. We must fetch the binary content via `https://api-data.line.me/v2/bot/message/{messageId}/content`.
    -   **Limitations**: Content must be fetched within a limited time window (usually a few days) before it's deleted from LINE servers. We *must* download and store it in our own storage (S3/R2) immediately.
-   **Verdict**: High feasibility. Requires backend upgrade to handle non-text message types and an object storage solution.

### 3.2 Web App vs. Native App (for "Invisible EMR")
-   **The "Pocket Recording" Dream**: The practitioner turns on recording, puts the phone in their pocket, and treats the patient.
-   **Web App (PWA/LIFF)**:
    -   **Pros**: Cross-platform, no app store friction, easy updates.
    -   **Cons**: **Background Audio Recording is unreliable.** Mobile browsers (especially iOS Safari) aggressively throttle or kill background tabs to save battery. If the screen locks, recording likely stops.
    -   **Workaround**: Use the **Screen Wake Lock API** to keep the screen on (dimmed) while recording. This is a viable "Phase 2" solution before building a native app.
-   **Native App**:
    -   **Pros**: Full background access, reliable recording, better camera integration.
    -   **Cons**: High development cost, app store distribution.
-   **Verdict**: Start with **Web App + Wake Lock**. If reliability is insufficient, build a lightweight "Companion App" (React Native/Flutter) specifically for recording/uploading in Phase 3.

## 4. Proposed Roadmap

### Phase 1: The Digital Foundation (Weeks 1-4)
*Goal: Centralize data. Get clinics off paper and scattered LINE chats.*

1.  **Expanded Patient Profile**:
    -   Transform `PatientDetail` into a "Patient Medical Record".
    -   Add **Clinical Notes**: A dedicated section for structured/unstructured notes (replacing the simple `notes` field).
    -   Add **File Vault**: A section to view all photos/docs associated with the patient.
2.  **LINE File Capture**:
    -   Upgrade LINE Webhook to ingest Images, Videos, and PDFs.
    -   **Workflow**: Patient sends X-ray on LINE -> System saves to S3 -> Appears in "Unassigned Files" or auto-assigned to Patient's file vault.
3.  **Basic Note Templates**:
    -   Allow clinics to define simple text templates (e.g., "SOAP Note", "Initial Eval").

### Phase 2: AI Assistance (Weeks 5-8)
*Goal: Reduce typing and provide intelligence.*

1.  **AI Transcription (Web-based)**:
    -   Add "Record Session" button to the web interface.
    -   Use **Wake Lock** to keep screen active.
    -   Upload audio -> Transcribe (Whisper) -> Save to note.
2.  **Smart Summarization**:
    -   Use LLM to summarize the transcription into a SOAP format.
    -   "Magic Button": Convert rough notes into professional medical language.
3.  **Chat-to-Note**:
    -   Select messages from the LINE history and click "Add to Record". AI summarizes the chat context.

### Phase 3: The "Invisible" EMR (Months 3+)
*Goal: Seamless, proactive experience.*

1.  **Proactive Suggestions**:
    -   Before appointment: "Patient Andy is coming for frozen shoulder. Last time he reported 30% pain reduction. Remind him to do exercise X."
2.  **Companion Mobile App**:
    -   If Web recording proves unstable, build a simple app for robust background recording and quick photo uploads.
3.  **RAG (Retrieval Augmented Generation)**:
    -   "Has this patient complained about knee pain before?" -> System searches all past notes/transcripts.

## 5. Detailed Phase 1 Implementation Plan

To get started immediately, we focus on **Data Structure** and **LINE Integration**.

### 5.1 Backend Changes
1.  **New Models**:
    -   `ClinicalNote`: `id`, `patient_id`, `practitioner_id`, `content` (JSON/Markdown), `visit_date`.
    -   `PatientFile`: `id`, `patient_id`, `file_type` (image/pdf), `storage_url`, `source` (line/upload), `line_message_id`.
    -   `NoteTemplate`: `id`, `clinic_id`, `name`, `structure` (schema).
2.  **Storage**:
    -   Set up S3-compatible storage (AWS S3, Cloudflare R2, or MinIO for local dev).
3.  **LINE Service Upgrade**:
    -   Modify `LINEService` to handle `image`, `video`, `file` events.
    -   Implement `fetch_message_content` method.

### 5.2 Frontend Changes
1.  **Patient Detail Page Overhaul**:
    -   **Tabs**: "Overview", "Timeline/Notes", "Files", "Chat History".
    -   **Timeline View**: Combined view of appointments and notes.
    -   **File Gallery**: Grid view of uploaded images.
2.  **Note Editor**:
    -   Rich text editor (e.g., TipTap or Quill) for writing notes.
    -   Template selector.

## 6. Conclusion

We start by solving the "fragmentation" problem. By pulling LINE files into the web platform, we give clinics an immediate "Aha!" moment ("Wow, I don't have to scroll through chat history anymore"). Once they trust the system with their data, we introduce AI features to save them time, cementing the platform as indispensable.
