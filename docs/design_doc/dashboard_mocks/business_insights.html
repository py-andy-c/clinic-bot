<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務洞察 - 儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Note: This mock uses Chart.js for visualization only. Actual implementation should use Recharts (already in dependencies) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-0 md:px-6 md:py-6">
        <!-- Page Header -->
        <div class="px-3 md:px-0 mb-4 md:mb-6">
            <div class="flex items-center gap-2">
                <h1 class="text-xl md:text-2xl font-semibold text-gray-900">業務洞察</h1>
                <button 
                    type="button"
                    class="inline-flex items-center justify-center p-1 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                    aria-label="查看說明"
                    onclick="document.getElementById('pageInfoModal').classList.remove('hidden')"
                >
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                </button>
            </div>
            <p class="text-xs md:text-sm text-gray-600 mt-1">查看診所營收趨勢、服務項目表現和治療師績效</p>
        </div>

        <!-- Filters -->
        <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-4 md:py-4 mb-4 md:mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 md:gap-4">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">開始日期</label>
                    <input type="date" value="2024-01-01" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">結束日期</label>
                    <input type="date" value="2024-01-31" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">治療師</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        <option value="">全部</option>
                        <option disabled style="background-color: #f3f4f6; color: #9ca3af;">─────────────</option>
                        <option value="1">王醫師</option>
                        <option value="2">李治療師</option>
                        <option value="3">陳治療師</option>
                        <option disabled style="background-color: #f3f4f6; color: #9ca3af;">─────────────</option>
                        <option value="null" style="color: #6b7280;">無</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">服務項目</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        <option value="">全部</option>
                        <option disabled style="background-color: #f3f4f6; color: #9ca3af;">─────────────</option>
                        <option value="1">初診評估</option>
                        <option value="2">復健治療</option>
                        <option value="3">物理治療</option>
                        <option value="4">諮詢服務</option>
                        <option disabled style="background-color: #f3f4f6; color: #9ca3af;">─────────────</option>
                        <option value="custom:特殊檢查" style="font-style: italic;">特殊檢查 <span style="color: #9ca3af; font-style: normal;">(自訂)</span></option>
                        <option value="custom:器材費" style="font-style: italic;">器材費 <span style="color: #9ca3af; font-style: normal;">(自訂)</span></option>
                        <option value="custom:材料費" style="font-style: italic;">材料費 <span style="color: #9ca3af; font-style: normal;">(自訂)</span></option>
                        <option value="custom:其他費用" style="font-style: italic;">其他費用 <span style="color: #9ca3af; font-style: normal;">(自訂)</span></option>
                        <option value="custom:諮詢費" style="font-style: italic;">諮詢費 <span style="color: #9ca3af; font-style: normal;">(自訂)</span></option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button class="w-full px-3 md:px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-xs md:text-sm font-medium">
                        套用篩選
                    </button>
                </div>
            </div>
            <div class="mt-3 md:mt-4 flex flex-wrap gap-2">
                <button class="px-2 md:px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" onclick="setDateRange('month')">本月</button>
                <button class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" onclick="setDateRange('3months')">最近3個月</button>
                <button class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" onclick="setDateRange('6months')">最近6個月</button>
                <button class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200" onclick="setDateRange('year')">最近1年</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 md:gap-4 mb-4 md:mb-6">
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-center gap-1 mb-1">
                    <p class="text-xs md:text-sm text-gray-600">總營收</p>
                    <button 
                        type="button"
                        class="inline-flex items-center justify-center p-0.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                        aria-label="查看總營收說明"
                        onclick="document.getElementById('revenueInfoModal').classList.remove('hidden')"
                    >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-lg md:text-2xl font-semibold text-gray-900">$ 450,000</p>
            </div>
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-center gap-1 mb-1">
                    <p class="text-xs md:text-sm text-gray-600">有效收據數</p>
                    <button 
                        type="button"
                        class="inline-flex items-center justify-center p-0.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                        aria-label="查看有效收據數說明"
                        onclick="document.getElementById('receiptCountInfoModal').classList.remove('hidden')"
                    >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-lg md:text-2xl font-semibold text-gray-900">156</p>
            </div>
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-center gap-1 mb-1">
                    <p class="text-xs md:text-sm text-gray-600">服務項目數</p>
                    <button 
                        type="button"
                        class="inline-flex items-center justify-center p-0.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                        aria-label="查看服務項目數說明"
                        onclick="document.getElementById('serviceItemCountInfoModal').classList.remove('hidden')"
                    >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-lg md:text-2xl font-semibold text-gray-900">198</p>
            </div>
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-center gap-1 mb-1">
                    <p class="text-xs md:text-sm text-gray-600">活躍病患</p>
                    <button 
                        type="button"
                        class="inline-flex items-center justify-center p-0.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                        aria-label="查看活躍病患說明"
                        onclick="document.getElementById('activePatientsInfoModal').classList.remove('hidden')"
                    >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-lg md:text-2xl font-semibold text-gray-900">89</p>
            </div>
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-center gap-1 mb-1">
                    <p class="text-xs md:text-sm text-gray-600">平均交易金額</p>
                    <button 
                        type="button"
                        class="inline-flex items-center justify-center p-0.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full"
                        aria-label="查看平均交易金額說明"
                        onclick="document.getElementById('avgTransactionInfoModal').classList.remove('hidden')"
                    >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p class="text-lg md:text-2xl font-semibold text-gray-900">$ 2,885</p>
            </div>
        </div>

        <!-- Revenue Trend Chart -->
        <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6 pt-6 border-t border-gray-200 md:pt-6 md:border-t-0 mb-4 md:mb-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-2 mb-3 md:mb-4">
                <h2 class="text-base md:text-lg font-semibold text-gray-900">營收趨勢</h2>
                <div class="flex items-center gap-2">
                    <label class="text-xs md:text-sm text-gray-600">顯示方式：</label>
                    <select id="chartView" class="px-3 py-1 border border-gray-300 rounded-md text-sm" onchange="updateChart()">
                        <option value="total">總營收</option>
                        <option value="stacked-service">依服務項目</option>
                        <option value="stacked-practitioner">依治療師</option>
                    </select>
                </div>
            </div>
            <div class="mb-2 text-xs md:text-sm text-gray-500" id="chartGranularity">顯示方式：每日</div>
            <div class="overflow-x-auto -mx-3 md:mx-0 px-3 md:px-0">
                <div class="h-64" style="min-width: 600px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Breakdown Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- By Service Type -->
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <h2 class="text-base md:text-lg font-semibold text-gray-900 mb-3 md:mb-4">依服務項目</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase">服務項目</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">營收</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">項目數</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">占比</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">初診評估</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 180,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">60</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">40%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">復健治療</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 200,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">88</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">44%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">物理治療</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 70,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">50</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">16%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">
                                    <span class="italic text-gray-600">特殊檢查</span>
                                    <span class="text-xs text-gray-400 ml-1">(自訂)</span>
                                </td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 15,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">5</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">3%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">
                                    <span class="italic text-gray-600">器材費</span>
                                    <span class="text-xs text-gray-400 ml-1">(自訂)</span>
                                </td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 8,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">4</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">2%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">
                                    <span class="italic text-gray-600">其他費用</span>
                                    <span class="text-xs text-gray-400 ml-1">(自訂)</span>
                                </td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 5,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">2</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">1%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">
                                    <span class="italic text-gray-600">諮詢費</span>
                                    <span class="text-xs text-gray-400 ml-1">(自訂)</span>
                                </td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 3,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">1</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">1%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- By Practitioner -->
            <div class="bg-white md:rounded-lg md:border md:border-gray-200 md:shadow-sm px-3 py-2 md:px-6 md:py-6">
                <h2 class="text-base md:text-lg font-semibold text-gray-900 mb-3 md:mb-4">依治療師</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase">治療師</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">營收</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">項目數</th>
                                <th class="px-2 md:px-4 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">占比</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">王醫師</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 200,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">85</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">44%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">李治療師</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 180,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">78</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">40%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-900">陳治療師</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 70,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">35</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">16%</td>
                            </tr>
                            <tr>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm font-medium text-gray-500">無</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-900 text-right">$ 5,000</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">3</td>
                                <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-500 text-right">1%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modals -->
    <!-- Page-level Info Modal -->
    <div id="pageInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-3 py-2 md:px-6 md:py-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">業務洞察說明</h3>
                            <button onclick="document.getElementById('pageInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700 space-y-3">
                            <p><strong>數據來源：</strong>本頁面所有財務指標均基於有效收據（不含作廢收據）計算。</p>
                            <p><strong>多項目處理：</strong>當一個預約在結帳時包含多個服務項目時，每個項目會分別計算在服務項目統計中。例如：一個收據包含「初診評估」和「復健治療」兩個項目，則兩個項目都會計入各自的統計。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metric Info Modals -->
    <div id="revenueInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">總營收</h3>
                            <button onclick="document.getElementById('revenueInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p>所選期間內所有有效收據的總金額總和。僅計算未作廢的收據。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="receiptCountInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">有效收據數</h3>
                            <button onclick="document.getElementById('receiptCountInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p>所選期間內有效（未作廢）收據的總數量。作廢的收據不計入此統計。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="serviceItemCountInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">服務項目數</h3>
                            <button onclick="document.getElementById('serviceItemCountInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p>所選期間內所有有效收據中服務項目的總數量。一個收據可以包含多個服務項目，每個項目都會分別計數。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="activePatientsInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">活躍病患</h3>
                            <button onclick="document.getElementById('activePatientsInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p>所選期間內有預約記錄的獨特病患數量。這是營運指標，與財務數據無直接關係。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="avgTransactionInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">平均交易金額</h3>
                            <button onclick="document.getElementById('avgTransactionInfoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p>總營收除以有效收據數。代表平均每筆收據的金額。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let revenueChart;

        // Calculate date range duration
        function getDateRangeDuration() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        // Determine granularity based on date range
        function getGranularity(days) {
            if (days <= 7) return { type: 'daily', label: '每日' };
            if (days <= 31) return { type: 'daily', label: '每日' };
            if (days <= 90) return { type: 'weekly', label: '每週' };
            if (days <= 365) return { type: 'monthly', label: '每月' };
            return { type: 'monthly', label: '每月' };
        }


        // Update chart granularity label
        function updateGranularityLabel() {
            const days = getDateRangeDuration();
            const granularity = getGranularity(days);
            document.getElementById('chartGranularity').textContent = `顯示方式：${granularity.label}`;
        }

        // Set date range presets
        function setDateRange(preset) {
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            let startDate, endDate;
            
            switch(preset) {
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case '3months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case '6months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
            }
            
            startDateInput.value = startDate.toISOString().split('T')[0];
            endDateInput.value = endDate.toISOString().split('T')[0];
            
            updateChart();
            updateGranularityLabel();
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const days = getDateRangeDuration();
            const granularity = getGranularity(days);
            
            // Sample data - in real implementation, this would come from API
            let labels, data;
            if (granularity.type === 'daily') {
                labels = Array.from({length: 31}, (_, i) => `${i + 1}日`);
                data = Array.from({length: 31}, () => Math.floor(Math.random() * 20000) + 10000);
            } else if (granularity.type === 'weekly') {
                labels = ['第1週', '第2週', '第3週', '第4週', '第5週', '第6週', '第7週', '第8週', '第9週', '第10週', '第11週', '第12週'];
                data = Array.from({length: 12}, () => Math.floor(Math.random() * 50000) + 50000);
            } else {
                labels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                data = Array.from({length: 12}, () => Math.floor(Math.random() * 100000) + 300000);
            }

            const chartView = document.getElementById('chartView').value;
            
            if (chartView === 'total') {
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.slice(0, Math.min(labels.length, data.length)),
                        datasets: [{
                            label: '總營收',
                            data: data,
                            borderColor: 'rgb(37, 99, 235)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$ ' + (value / 1000) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (chartView === 'stacked-service') {
                // Stacked view by service type - stacked area chart with solid colors
                const service1 = data.map(v => Math.floor(v * 0.4)); // 初診評估
                const service2 = data.map(v => Math.floor(v * 0.44)); // 復健治療
                const service3 = data.map(v => Math.floor(v * 0.16)); // 物理治療
                const service4 = data.map(v => Math.floor(v * 0.0)); // 其他 (custom items) - minimal for demo
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.slice(0, Math.min(labels.length, data.length)),
                        datasets: [
                            {
                                label: '初診評估',
                                data: service1,
                                borderColor: 'rgb(37, 99, 235)',
                                backgroundColor: 'rgb(37, 99, 235)', // Solid color
                                tension: 0.4,
                                fill: 'origin'
                            },
                            {
                                label: '復健治療',
                                data: service2.map((v, i) => service1[i] + v),
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgb(16, 185, 129)', // Solid color
                                tension: 0.4,
                                fill: '-1'
                            },
                            {
                                label: '物理治療',
                                data: service3.map((v, i) => service1[i] + service2[i] + v),
                                borderColor: 'rgb(245, 158, 11)',
                                backgroundColor: 'rgb(245, 158, 11)', // Solid color
                                tension: 0.4,
                                fill: '-1'
                            },
                            {
                                label: '其他',
                                data: service4.map((v, i) => service1[i] + service2[i] + service3[i] + v),
                                borderColor: 'rgb(156, 163, 175)',
                                backgroundColor: 'rgb(156, 163, 175)', // Solid color for custom items
                                tension: 0.4,
                                fill: '-1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const index = context.dataIndex;
                                        if (context.datasetIndex === 0) {
                                            label += '$ ' + (service1[index] / 1000).toFixed(1) + 'k';
                                        } else if (context.datasetIndex === 1) {
                                            label += '$ ' + (service2[index] / 1000).toFixed(1) + 'k';
                                        } else if (context.datasetIndex === 2) {
                                            label += '$ ' + (service3[index] / 1000).toFixed(1) + 'k';
                                        } else {
                                            label += '$ ' + (service4[index] / 1000).toFixed(1) + 'k';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                stacked: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$ ' + (value / 1000) + 'k';
                                    }
                                }
                            },
                            x: {
                                stacked: true
                            }
                        }
                    }
                });
            } else {
                // Stacked view by practitioner - stacked area chart with solid colors
                const prac1 = data.map(v => Math.floor(v * 0.44)); // 王醫師
                const prac2 = data.map(v => Math.floor(v * 0.40)); // 李治療師
                const prac3 = data.map(v => Math.floor(v * 0.16)); // 陳治療師
                const prac4 = data.map(v => Math.floor(v * 0.0)); // 無 (null practitioner) - minimal for demo
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.slice(0, Math.min(labels.length, data.length)),
                        datasets: [
                            {
                                label: '王醫師',
                                data: prac1,
                                borderColor: 'rgb(37, 99, 235)',
                                backgroundColor: 'rgb(37, 99, 235)', // Solid color
                                tension: 0.4,
                                fill: 'origin'
                            },
                            {
                                label: '李治療師',
                                data: prac2.map((v, i) => prac1[i] + v),
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgb(16, 185, 129)', // Solid color
                                tension: 0.4,
                                fill: '-1'
                            },
                            {
                                label: '陳治療師',
                                data: prac3.map((v, i) => prac1[i] + prac2[i] + v),
                                borderColor: 'rgb(245, 158, 11)',
                                backgroundColor: 'rgb(245, 158, 11)', // Solid color
                                tension: 0.4,
                                fill: '-1'
                            },
                            {
                                label: '無',
                                data: prac4.map((v, i) => prac1[i] + prac2[i] + prac3[i] + v),
                                borderColor: 'rgb(156, 163, 175)',
                                backgroundColor: 'rgb(156, 163, 175)', // Solid color for null practitioner
                                tension: 0.4,
                                fill: '-1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const index = context.dataIndex;
                                        if (context.datasetIndex === 0) {
                                            label += '$ ' + (prac1[index] / 1000).toFixed(1) + 'k';
                                        } else if (context.datasetIndex === 1) {
                                            label += '$ ' + (prac2[index] / 1000).toFixed(1) + 'k';
                                        } else if (context.datasetIndex === 2) {
                                            label += '$ ' + (prac3[index] / 1000).toFixed(1) + 'k';
                                        } else {
                                            label += '$ ' + (prac4[index] / 1000).toFixed(1) + 'k';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                stacked: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$ ' + (value / 1000) + 'k';
                                    }
                                }
                            },
                            x: {
                                stacked: true
                            }
                        }
                    }
                });
            }
        }

        // Update chart view
        function updateChart() {
            if (revenueChart) {
                revenueChart.destroy();
            }
            initChart();
        }

            // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateGranularityLabel();
        });
    </script>
</body>
</html>
