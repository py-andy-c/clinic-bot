# Analysis: Clinic ID Lost After First-Time Registration

## Issue Summary

When a patient attempts to make an appointment from the rich menu for the first time, they are prompted to enter their name and phone number. After successful registration, instead of being redirected to the appointment making page, they see the error:

**"診所ID無效，請從診所的LINE官方帳號進入"** (Clinic ID invalid, please enter from the clinic's LINE official account)

**Severity**: CRITICAL - Blocks first-time users from completing appointment booking  
**Affected Users**: All first-time patients attempting to book appointments via rich menu  
**Workaround**: None - users cannot proceed past registration

## Root Cause

The issue occurs in `FirstTimeRegister.tsx` at line 52. After successful patient registration, the component updates the URL to remove the `clinic_id` parameter:

```52:54:frontend/src/liff/auth/FirstTimeRegister.tsx
// Registration successful - update URL and trigger auth refresh
const newUrl = `${window.location.pathname}?mode=book`;
window.history.replaceState(null, '', newUrl);
```

This causes the `clinic_id` query parameter to be lost from the URL.

## Flow Analysis

### Expected Flow

1. User clicks rich menu → LIFF app opens with URL: `https://liff.line.me/YOUR_LIFF_ID?clinic_id=123`
2. `useLineAuth` hook extracts `clinic_id` from URL and authenticates user
3. Backend returns `is_first_time: true` → `FirstTimeRegister` component is shown
4. User enters name and phone → `createPrimaryPatient` API is called
5. Registration successful → URL updated and auth refresh triggered
6. After refresh → User should see appointment booking page

### Actual Flow (Broken)

1. User clicks rich menu → LIFF app opens with URL: `https://liff.line.me/YOUR_LIFF_ID?clinic_id=123`
2. `useLineAuth` hook extracts `clinic_id` from URL and authenticates user
3. Backend returns `is_first_time: true` → `FirstTimeRegister` component is shown
4. User enters name and phone → `createPrimaryPatient` API is called
5. Registration successful → **URL updated to `?mode=book` (clinic_id lost)**
6. `auth-refresh` event dispatched → triggers `window.location.reload()` in `useLineAuth.ts:136`
7. After reload → `useLineAuth` hook runs again
8. `getClinicIdFromUrl()` called at line 92 → returns `null` (clinic_id not in URL)
9. Error thrown at line 94: `throw new Error('診所ID無效，請從診所的LINE官方帳號進入');`

## Code References

### Problem Location

```52:54:frontend/src/liff/auth/FirstTimeRegister.tsx
// Registration successful - update URL and trigger auth refresh
const newUrl = `${window.location.pathname}?mode=book`;
window.history.replaceState(null, '', newUrl);
```

### Error Location

```92:95:frontend/src/hooks/useLineAuth.ts
const clinicId = getClinicIdFromUrl();
if (!clinicId) {
  throw new Error('診所ID無效，請從診所的LINE官方帳號進入');
}
```

### URL Extraction Function

```30:34:frontend/src/hooks/useLineAuth.ts
const getClinicIdFromUrl = (): number | null => {
  const urlParams = new URLSearchParams(window.location.search);
  const clinicIdParam = urlParams.get('clinic_id');
  return clinicIdParam ? parseInt(clinicIdParam, 10) : null;
};
```

### Auth Refresh Handler

```132:141:frontend/src/hooks/useLineAuth.ts
useEffect(() => {
  const handleAuthRefresh = () => {
    logger.log('Auth refresh event received');
    // Trigger re-run of main authentication logic
    window.location.reload();
  };

  window.addEventListener('auth-refresh', handleAuthRefresh);
  return () => window.removeEventListener('auth-refresh', handleAuthRefresh);
}, []);
```

## Why This Happens

The `FirstTimeRegister` component updates the URL to add the `mode=book` parameter but doesn't preserve existing query parameters, specifically `clinic_id`. When the page reloads after the `auth-refresh` event, the authentication hook can no longer find the `clinic_id` in the URL.

**Note**: See "Comprehensive Solution Analysis" section below for detailed solution options and implementation strategies.

## Additional Issues Discovered

### Issue 1: Inconsistent `clinic_id` Source

The authentication flow has **two potential sources** for `clinic_id`:
1. **URL parameter** (via `getClinicIdFromUrl()`) - Currently used exclusively
2. **JWT token payload** - Contains `clinic_id` but is never extracted

The JWT token includes `clinic_id` (set in backend `liff.py` line 270), but the frontend never decodes it. When validating existing tokens (lines 54-62), the code only checks the URL for `clinic_id`, not the token itself.

**Impact**: Even with a valid JWT token containing `clinic_id`, if the URL loses it, authentication fails.

### Issue 2: Full Page Reload on Auth Refresh

The `auth-refresh` event handler uses `window.location.reload()` (line 136), which:
- Causes full page reload (poor UX)
- Loses all React state
- Could cause race conditions
- Is unnecessary - could use state updates instead

### Issue 3: Missing URL Parameter Preservation Utility

No utility function exists to preserve query parameters when updating URLs. Each component that modifies the URL must manually preserve `clinic_id`, leading to bugs like this one.

## Additional Notes

- The `clinicId` is stored in both `useLineAuth` state (line 25) and `appointmentStore` (line 46), but neither persists across page reloads
- The appointment store's `clinicId` is set from `useLineAuth`'s `clinicId` in `LiffApp.tsx` (line 34-38), but this happens after authentication
- The backend returns `clinic_id` in the `LiffLoginResponse` (line 109), but this is only available after successful authentication
- The JWT token contains `clinic_id` in its payload (backend `liff.py` line 270), but this is never decoded or used by the frontend

## Comprehensive Solution Analysis

After reviewing multiple analyses, here are all proposed solutions with pros/cons:

### Solution 1: Preserve `clinic_id` in URL Update (RECOMMENDED - Immediate Fix)

**Approach**: Modify `FirstTimeRegister.tsx` to preserve existing query parameters when updating the URL.

**Implementation**:
```typescript
// Get current URL parameters
const urlParams = new URLSearchParams(window.location.search);
// Preserve clinic_id if it exists
// Add or update mode parameter
urlParams.set('mode', 'book');
// Build new URL with all parameters
const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
window.history.replaceState(null, '', newUrl);
```

**Pros**:
- ✅ Simple, minimal code changes
- ✅ Preserves clinic context in URL (source of truth)
- ✅ Maintains consistency with existing architecture
- ✅ Preserves ALL existing query parameters, not just `clinic_id`
- ✅ No changes to authentication flow required

**Cons**:
- None - this is the cleanest solution

**Files to Modify**: `frontend/src/liff/auth/FirstTimeRegister.tsx`

### Solution 2: Store Clinic ID in localStorage (Alternative Approach)

**Approach**: Store `clinic_id` in localStorage during initial authentication, use as fallback when URL parameter is missing.

**Implementation**:
```typescript
// In useLineAuth.ts, modify getClinicIdFromUrl:
const getClinicIdFromUrl = (): number | null => {
  const urlParams = new URLSearchParams(window.location.search);
  const clinicIdParam = urlParams.get('clinic_id');
  if (clinicIdParam) {
    localStorage.setItem('liff_clinic_id', clinicIdParam);
    return parseInt(clinicIdParam, 10);
  }
  // Fallback to localStorage
  const stored = localStorage.getItem('liff_clinic_id');
  return stored ? parseInt(stored, 10) : null;
};

// Clear on logout
const logout = () => {
  localStorage.removeItem('liff_jwt_token');
  localStorage.removeItem('liff_clinic_id');
  // ... rest of logout logic
};
```

**Pros**:
- ✅ Survives page reloads
- ✅ Maintains backward compatibility
- ✅ Can work even if URL parameter is lost

**Cons**:
- ❌ Adds localStorage dependency
- ❌ Potential for stale data if user switches clinics
- ❌ Requires cleanup logic
- ❌ Doesn't address root cause (URL still loses parameter)

**Files to Modify**: `frontend/src/hooks/useLineAuth.ts`

### Solution 3: Extract `clinic_id` from JWT Token (Defense in Depth)

**Approach**: Decode JWT token to extract `clinic_id` as fallback when URL doesn't have it.

**Implementation**:
```typescript
// Add JWT decode utility
const decodeJWT = (token: string): any => {
  try {
    const payload = token.split('.')[1];
    return JSON.parse(atob(payload));
  } catch (e) {
    return null;
  }
};

// Modify token validation in useLineAuth.ts:
if (response.ok && !cancelled) {
  setIsAuthenticated(true);
  setIsFirstTime(false);
  
  // Try URL first, then JWT token as fallback
  let clinicIdValue = getClinicIdFromUrl();
  if (!clinicIdValue && token) {
    const payload = decodeJWT(token);
    clinicIdValue = payload?.clinic_id;
  }
  
  if (clinicIdValue) {
    setClinicId(clinicIdValue);
  }
}
```

**Pros**:
- ✅ Uses existing data (JWT token)
- ✅ Provides fallback mechanism
- ✅ No additional storage needed

**Cons**:
- ❌ More complex implementation
- ❌ Requires JWT decoding utility
- ❌ Still doesn't fix root cause
- ❌ JWT might not be available on first-time user flow

**Files to Modify**: `frontend/src/hooks/useLineAuth.ts`, possibly create `frontend/src/utils/jwtUtils.ts`

### Solution 4: Create URL Parameter Utility Function (Best Practice)

**Approach**: Create a reusable utility function for preserving query parameters when updating URLs.

**Implementation**:
```typescript
// frontend/src/utils/urlUtils.ts
export const preserveQueryParams = (
  pathname: string,
  paramsToSet: Record<string, string>,
  paramsToPreserve: string[] = ['clinic_id']
): string => {
  const urlParams = new URLSearchParams(window.location.search);
  
  // Preserve specified params
  paramsToPreserve.forEach(param => {
    const value = urlParams.get(param);
    if (value) {
      urlParams.set(param, value);
    }
  });
  
  // Set new params
  Object.entries(paramsToSet).forEach(([key, value]) => {
    urlParams.set(key, value);
  });
  
  return `${pathname}?${urlParams.toString()}`;
};

// Usage in FirstTimeRegister.tsx:
import { preserveQueryParams } from '../../utils/urlUtils';
const newUrl = preserveQueryParams(window.location.pathname, { mode: 'book' });
```

**Pros**:
- ✅ Reusable across entire codebase
- ✅ Prevents similar bugs in future
- ✅ Clean, maintainable code
- ✅ Can be combined with Solution 1

**Cons**:
- ❌ Requires creating new utility file
- ❌ Other components need to adopt it

**Files to Create**: `frontend/src/utils/urlUtils.ts`  
**Files to Modify**: `frontend/src/liff/auth/FirstTimeRegister.tsx` (and potentially other components)

### Solution 5: Avoid Full Page Reload (UX Improvement)

**Approach**: Replace `window.location.reload()` with state-based auth refresh.

**Implementation**:
```typescript
// Modify auth-refresh handler in useLineAuth.ts:
useEffect(() => {
  const handleAuthRefresh = () => {
    logger.log('Auth refresh event received');
    // Re-run authentication logic without reload
    if (lineProfile && liffAccessToken) {
      performAuthentication(lineProfile.userId, lineProfile.displayName, liffAccessToken);
    }
  };

  window.addEventListener('auth-refresh', handleAuthRefresh);
  return () => window.removeEventListener('auth-refresh', handleAuthRefresh);
}, [lineProfile, liffAccessToken]);
```

**Pros**:
- ✅ Better UX (no page reload)
- ✅ Preserves React state
- ✅ Faster refresh

**Cons**:
- ❌ More complex implementation
- ❌ Requires refactoring auth flow
- ❌ Doesn't address root cause directly

**Files to Modify**: `frontend/src/hooks/useLineAuth.ts`

## Recommended Implementation Strategy

### Phase 1: Immediate Fix (CRITICAL)
**Implement Solution 1** - Preserve `clinic_id` in URL update in `FirstTimeRegister.tsx`
- Quick fix that resolves the bug immediately
- Minimal risk
- No architectural changes needed

### Phase 2: Defense in Depth (RECOMMENDED)
**Implement Solution 3** - Extract `clinic_id` from JWT token as fallback
- Adds resilience to authentication flow
- Handles edge cases where URL might lose parameters
- Uses existing data (no new storage)

### Phase 3: Best Practices (OPTIONAL)
**Implement Solution 4** - Create URL parameter utility function
- Prevents similar bugs in future
- Improves code maintainability
- Apply to all URL manipulation code

### Phase 4: UX Enhancement (OPTIONAL)
**Implement Solution 5** - Avoid full page reload
- Improves user experience
- Requires more testing
- Can be done separately from bug fix

## Testing Checklist

After implementing fixes, verify:

- [ ] First-time user can complete registration and proceed to appointment booking
- [ ] URL contains both `clinic_id` and `mode=book` after registration
- [ ] Returning users are not affected
- [ ] Other URL parameters (if any) are preserved
- [ ] Direct navigation with `clinic_id` parameter still works
- [ ] Logout and re-authentication works correctly
- [ ] Clinic isolation still works correctly
- [ ] URL parameters persist when navigating between modes (`book`, `query`, `settings`)
- [ ] Page refresh after registration maintains clinic context
- [ ] Error recovery scenarios work (e.g., network errors, expired tokens)

## Related Files

- `frontend/src/liff/auth/FirstTimeRegister.tsx` - **PRIMARY BUG LOCATION**
- `frontend/src/hooks/useLineAuth.ts` - Authentication logic with `clinic_id` handling
- `frontend/src/liff/LiffApp.tsx` - Main LIFF app component
- `frontend/src/stores/appointmentStore.ts` - Stores clinicId
- `backend/src/api/liff.py` - Backend LIFF endpoints (JWT token generation)
- `frontend/src/services/liffApi.ts` - API service layer

## Priority

**CRITICAL** - This bug prevents first-time users from completing registration and accessing the appointment booking system. Immediate fix required.

