# Railway Config as Code
# This file configures the build and deployment for Railway
# See: https://docs.railway.com/guides/config-as-code
# Configuration defined here overrides dashboard settings

[build]
# Use Railpack (default) - Railway's modern buildpack
# Railway will auto-detect dependencies from requirements.txt
builder = "RAILPACK"

# Specify Python version and system dependencies via nixpacksPlan (Railpack respects this)
# This replaces runtime.txt for Python version specification
# WeasyPrint requires Cairo, Pango, GDK-PixBuf, and GLib system libraries
# Note: Nix packages may not expose libraries in standard paths, so we also need apt packages
# Set RAILPACK_BUILD_APT_PACKAGES and RAILPACK_DEPLOY_APT_PACKAGES environment variables:
# libglib2.0-0 libcairo2 libpango-1.0-0 libgdk-pixbuf2.0-0 libpangoft2-1.0-0
[build.nixpacksPlan]
[build.nixpacksPlan.phases]
[build.nixpacksPlan.phases.setup]
nixPkgs = ["python312", "cairo", "pango", "gdk-pixbuf", "glib"]

[deploy]
# Start command - runs migrations and starts the app via start.sh
# start.sh handles: alembic directory fix, migrations, and app startup
startCommand = "bash start.sh"

# Health check configuration
healthcheckPath = "/health"
healthcheckTimeout = 180  # Increased to 3 minutes to allow for migrations and startup

# Restart policy - restart on failure
restartPolicyType = "ALWAYS"

# Environment variables for Railpack to install apt packages
# These are needed because Nix packages may not expose libraries in standard paths
[variables]
RAILPACK_BUILD_APT_PACKAGES = "libglib2.0-0 libcairo2 libpango-1.0-0 libgdk-pixbuf2.0-0 libpangoft2-1.0-0"
RAILPACK_DEPLOY_APT_PACKAGES = "libglib2.0-0 libcairo2 libpango-1.0-0 libgdk-pixbuf2.0-0 libpangoft2-1.0-0"

